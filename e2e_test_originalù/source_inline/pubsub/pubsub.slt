control substitution on

system ok
e2e_test/source_inline/pubsub/prepare-data.rs

# fail with invalid emulator_host
statement error failed to lookup address information
CREATE TABLE s1 (v1 int, v2 varchar) WITH (
    connector = 'google_pubsub',
    pubsub.subscription = 'test-subscription-1',
    pubsub.emulator_host = 'invalid_host:5981'
) FORMAT PLAIN ENCODE JSON;

statement ok
CREATE TABLE s1 (v1 int, v2 varchar) WITH (
    ${RISEDEV_PUBSUB_WITH_OPTIONS_COMMON},
    pubsub.subscription = 'test-subscription-1',
) FORMAT PLAIN ENCODE JSON;

statement ok
SELECT * FROM s1;

statement ok
DROP TABLE s1;

statement error subscription test-subscription-not-exist does not exist
CREATE TABLE s2 (v1 int, v2 varchar) WITH (
    ${RISEDEV_PUBSUB_WITH_OPTIONS_COMMON},
    pubsub.subscription = 'test-subscription-not-exist',
) FORMAT PLAIN ENCODE JSON;

statement ok
CREATE TABLE s2 (v1 int, v2 varchar) WITH (
    ${RISEDEV_PUBSUB_WITH_OPTIONS_COMMON},
    pubsub.subscription = 'test-subscription-2',
) FORMAT PLAIN ENCODE JSON;

# fail if both start_offset and start_snapshot are provided
statement error specify at most one of start_offset or start_snapshot
CREATE TABLE s3 (v1 int, v2 varchar) WITH (
    ${RISEDEV_PUBSUB_WITH_OPTIONS_COMMON},
    pubsub.subscription = 'test-subscription-3',
    pubsub.start_offset.nanos = '121212',
    pubsub.start_snapshot = 'snapshot-that-doesnt-exist'
) FORMAT PLAIN ENCODE JSON;

# wait for source
sleep 10s

# flush data into storage
statement ok
flush;

query IT rowsort
select v1, v2 FROM s2;
----
0 name5
0 name9
1 name0
1 name7
2 name0
2 name3
3 name2
3 name9
4 name6
4 name7
5 name3
5 name8
6 name3
6 name4
7 name0
7 name5
8 name8
8 name9
9 name2
9 name2

statement ok
DROP TABLE s2;

